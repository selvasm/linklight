---
- hosts: localhost
  become: false
  gather_facts: false
  vars_files:
    - Creation_vars.yml
  tasks:
    - name: Create new  Routers
      azure_rm_virtualmachine:
        resource_group: AnsibleTower-Killian-Zoubayer
        name: "{{ item.name }}"
        admin_username: "{{ ansible_username }}"
        admin_password: "{{ ansible_password }}"
        image:
          offer: cisco-csr-1000v
          publisher: cisco
          sku: '16_12-payg-sec'
          version: 16.12.120190816
        plan:
          product: cisco-csr-1000v
          publisher: cisco
          name: '16_12-payg-sec'
        data_disks:
          - lun: 0
            disk_size_gb: 8
        os_disk_size_gb: 8
        location: francecentral
        vm_size: Standard_DS4_v2
        subnet: "{{ item.name }}-Subnet"
        virtual_network_name: ansible-vnet
        network_interfaces: "{{ item.interface }}"
        tags:
          env: demo
      with_items: "{{ routerlist }}"
      async: 45
      poll: 0
    
    - name: To Sleep for sometime and let the azure to create VM
      command: sleep 240

    - name: To Wait till the routers are Created
      wait_for:
        host: "{{ item.name }}"
        state: present
        delay: 10
        timeout: 120 
        connection_timeout: 20
        with_items: "{{ routerlist }}"
